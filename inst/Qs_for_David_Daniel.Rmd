---
title: "Questions for David and Daniel"
author: "Fonti Kar"
date: "29/09/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(smatr)
library(dplyr)
data("leaflife")

# Set up data, filtering low soil pH group
leaf.low.soilp <- leaflife %>% filter(soilp == 'low')

#Create a measurement error matrix
V2 = matrix(c(0.01,0,0.0,0.01),2,2)
```

### tl;dr

1. Measurement error matrix (V2) is used in SMA calculations *only* when fitting common slope and testing for differences in elevation between groups (Scenario 3) e.g. `sma(longev~lma+rain, data=leaf.low.soilp, V = V2)`
2. Adding in `slope.test = 1` to Scenario 3 stops V2 from being used (Scenario 5)
2. V2 is not used in all other circumstances (Scenario 1, 2, 4, 5) 
3. There are discrepancies between elevation and slope coefficients from `sma` and `elev.com`, `slope.test` and `slope.com` **which one is correct?**

Below I have created various scenarios using `sma()` and compared the coefficients for elevation and slope between fits that does not account for measurement error (suffix: `_sma`) and fits that apparently is accounts for measurement error (suffix: `_me_sma`). 

### Scenario 1: The most simple model fit (no transformation, nada!)

The output from `fit1_sma` and `fit1_me_sma` matches, meaning V2 is **not** taken into calculations

```{r univariate fit}
#Default
fit1_sma <- sma(longev~lma, data=leaf.low.soilp)
fit1_sma$coef

#Supplied with measurement error matrix
fit1_me_sma <- sma(longev~lma, data=leaf.low.soilp, V = V2)
fit1_me_sma$coef
```

### Scenario 2: OK lets add in a transformation

The output from `fit2_sma` and `fit2_me_sma` matches, meaning V2 is **not** taken into calculations

```{r log}
#Default
fit2_sma <- sma(longev~lma, log = "xy", data=leaf.low.soilp)
fit2_sma$coef

#Supplied with measurement error matrix
fit2_me_sma <- sma(longev~lma, log = "xy", data=leaf.low.soilp, V = V2)
fit2_me_sma$coef
```

### Scenario 3: Lets add in a grouping variable -  just like Robert did.

In this scenario, we are testing for common elevation among different levels of rainfall (same elevation, different slopes are fitted). 
Note that I removed the log transformations because warnings triggered (NAN produced on log scale)

The output from `fit3_sma` and `fit3_me_sma` are different suggesting V2 **is** taken into calculations. As expected, slopes are the same across both levels of rain.

```{r elevation group test}
#Default
fit3_sma <- sma(longev~lma+rain, data=leaf.low.soilp)
fit3_sma$coef

#Supplied with measurement error matrix
fit3_me_sma <- sma(longev~lma+rain, data=leaf.low.soilp, V = V2)
fit3_me_sma$coef
```

### Scenario 4: Lets now test for a common slope among different levels of rainfall 

The output from `fit4_sma` and `fit4_me_sma` matches, meaning V2 is **not** taken into calculations

```{r slope group test}
#Default
fit4_sma <- sma(longev~lma*rain, data=leaf.low.soilp)
fit4_sma$coef

#Supplied with measurement error matrix
fit4_me_sma <- sma(longev~lma*rain, data=leaf.low.soilp, V = V2) 
fit4_me_sma$coef
```

### Scenario 5: Lets now test common elevation and whether slope = 1 among different levels of rainfall  - Robert's situation

This is the same (as far as I can tell) as Robert's situation. 

The output from `fit5_sma` and `fit5_me_sma` matches, meaning V2 is **not** taken into calculations

Something about **adding in `slope.test = 1` stops V2 being used**

```{r slope is one?}
#Default
fit5_sma <- sma(longev~lma+rain, slope.test = 1, data=leaf.low.soilp)
fit5_sma$coef

#Supplied with measurement error matrix
fit5_me_sma <- sma(longev~lma+rain, slope.test = 1, data=leaf.low.soilp, V = V2) 
fit5_me_sma$coef
```

### Cross verify with other functions 

I wanted to further investigate **Scenario 3** further using `elev.com` and **Scenario 5** using `slope.test` (functions for testing equal elevation/slope among groups). According to the documentation `?elev.com`, the tests are built in `sma` using the syntax: `sma(y ~ x + groups)`. so this seemed like a sensible approach to cross verify `sma()` output!  

### Using elev.com to recreate Scenario 3

- The elevation values from `fit3_elev.com` and `fit3_sma` matches ✅
- The elevation values from `fit3_me_elev.com` and `fit3_me_sma` matches ✅
- **Importantly**, the elevation values  from `fit3_elev.com` and `fit3_me_elev.com` are different suggesting V2 **is** taken into calculations. ✅

```{r common elevation}
#Default
fit3_elev.com  <- with(leaf.low.soilp, 
                       elev.com(longev, lma, rain))

#Supplied with measurement error matrix
fit3_me_elev.com  <- with(leaf.low.soilp, 
                          elev.com(longev, lma, rain, V = array( V2, c(dim(V2), 2))))

# Compare elevation output with sma output from Scenario 3 above
# Output should match for elevation values
#Default
fit3_sma$coef
fit3_elev.com$as

#Supplied with measurement error matrix
fit3_me_sma$coef
fit3_me_elev.com$as
```

### Using slope.test for Scenario 5 - testing whether slope = 1 

`slope.test` is a one sample test so we need to apply it to each level of rainfall in the `leaf.low.soilp` dataset. For illustrative purpose, just doing it for the high rainfall group

- The slope values from `fit5_slope.test` and `fit5_sma` matches ✅
- The slope values from `fit5_me_slope.test` and `fit5_me_sma` are CLOSE but does **not** match! ❌ but **which values are correct?**
- **Importantly**, the slope values  from `fit5_slope.test` and `fit5_me_slope.test` are different suggesting V2 **is** taken into calculations. ✅

```{r slope.test multiple one-sample tests}
#Default
fit5_slope.test <- with(leaf.low.soilp %>% filter(rain == "high"), 
        slope.test(longev, lma, test.value = 1)
) 

#Supplied with measurement error matrix
fit5_me_slope.test <- with(leaf.low.soilp %>% filter(rain == "high"), 
                           slope.test(longev, lma, test.value = 1, V = V2)
) 

# Compare slope output with sma output from Scenario 5 above for each level of rain
# Slope value should match
#Default
fit5_sma$coef$high
fit5_slope.test

#Supplied with measurement error matrix
fit5_me_sma$coef$high
fit5_me_slope.test
```

### Other problems: Don't even get me started with lines.cis() - TBC

#### Using slope.com for Scenario 4 - testing common slope among different levels of rainfall 

- The values for slope from `fit4_sma` and `fit4_slope.com` matches ✅
- The values for slope  from  `fit4_me_sma` and `fit4_me_slope.com`  are CLOSE but does **not** match! ❌ but **which values are correct?**
- **Importantly**, the slope values  from `fit4_slope.com` and `fit4_me_slope.com` are different suggesting V2 **is** taken into calculations

```{r common slope}
#Default
fit4_slope.com <- with(leaf.low.soilp, 
                                slope.com(longev, lma, rain))

#Supplied with measurement error matrix
fit4_me_slope.com <- with(leaf.low.soilp, 
                          slope.com(longev, lma, rain, V = array( V2, c(dim(V2), 2))))

# Compare slope output sma output from Scenario 4 above
# Output should match for slope values
#Default
fit4_sma$coef
fit4_slope.com$bs

#Supplied with measurement error matrix
fit4_me_sma$coef
fit4_me_slope.com$bs
```

#### Using slope.com for Scenario 4, testing slope = 1 among different levels of rainfall 
-  The values for slope from `fit5_sma` and `fit5_slope.com` matches ✅
-  The values for likelihood ratio + p value (after rounding) for `slope.test` from `fit5_sma` and `fit5_slope.com` matches ✅
-  The values for slope from `fit5_me_sma` and `fit5_me_slope.com` are CLOSE but does **not** match! ❌  but **which values are correct?**
-  The values for likelihood ratio + p value (after rounding) for `slope.test` from `fit5_me_sma` and `fit5_me_slope.com` matches ✅
- **Importantly**, the slope values  from `fit5_slope.com` and `fit5_me_slope.com` are different suggesting V2 **is** taken into calculations

```{r common slope, slope is one?}
#Default
fit5_slope.com <- with(leaf.low.soilp, 
                                slope.com(longev, lma, rain, slope.test = 1))

#Supplied with measurement error matrix
fit5_me_slope.com <- with(leaf.low.soilp, 
                          slope.com(longev, lma, rain, 
                                    slope.test = 1, V = array( V2, c(dim(V2), 2))))

# Compare slope output sma output from Scenario 5 above
# Output for the slope.test and slope should match
#Default
fit5_sma ; fit5_sma$coef
fit5_slope.com

#Supplied with measurement error matrix
fit5_me_sma ;  fit5_me_sma$coef
fit5_me_slope.com
```



